!function(){"use strict";!function(t){let e=!1;const n={config:{apiUrl:"http://localhost:8000/api/v1/translate",siteId:null,sourceLanguage:"en",targetLanguage:null,apiKey:null,autoTranslate:!0,selectors:{include:["p","h1","h2","h3","h4","h5","h6","li","td","th","button","label","span"],exclude:[".no-translate","[data-no-translate]"]}},_translationRetries:0,_languageSelectorButton:null,_mutationTimeout:null,_observer:null,_languageMapping:{en:"Original",hi:"‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)",mr:"‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)",ta:"‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)",kn:"‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)",pa:"‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)",gu:"‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)"},_originalContentKey:"translationSDK_originalContent",_cacheKey:"translationSDK_cache",_setupRouteChangeListener:function(){console.log("[Route] Setting up route change listener.");const e=history.pushState;history.pushState=function(){e.apply(history,arguments),t.dispatchEvent(new Event("locationchange"))};const o=history.replaceState;history.replaceState=function(){o.apply(history,arguments),t.dispatchEvent(new Event("locationchange"))},t.addEventListener("popstate",(function(){t.dispatchEvent(new Event("locationchange"))})),t.addEventListener("locationchange",(()=>{console.log("[Route] Route changed. Retrying translation..."),setTimeout((()=>{n.translatePage(n.config.targetLanguage)}),500)}))},_getCache:function(){console.log("[Cache] Retrieving cache from localStorage.");const t=localStorage.getItem(this._cacheKey);try{const e=t?JSON.parse(t):{};return console.log("[Cache] Current cache:",e),e}catch(t){return console.error("[Cache] Error parsing cache:",t),{}}},_setCache:function(t){console.log("[Cache] Saving cache to localStorage:",t),localStorage.setItem(this._cacheKey,JSON.stringify(t))},_computeHash:function(t){const e=SparkMD5.hash(t);return console.log("[Hash] Computed hash using SparkMD5:",e),e},extractContent:function(){console.log("[Extract] Extracting content using selectors.");const t=this.config.selectors.include.join(","),e=Array.from(document.querySelectorAll(t)),n=this.config.selectors.exclude.join(","),o=n?Array.from(document.querySelectorAll(n)):[],a=e.filter((t=>!o.some((e=>e.contains(t)||t.contains(e)))));console.log("[Extract] Found",a.length,"elements after filtering.");const i=a.map((t=>{const e=t.textContent.trim();if(!e)return null;let n=t.id;n&&0!==n.length?console.log("[Extract] Using existing id for element:",n):(n="el-"+this._computeHash(e),t.id=n,console.log("[Extract] Assigned new id to element:",n));const o=t.tagName.toLowerCase();let a="other";["h1","h2","h3","h4","h5","h6"].includes(o)?a="heading":"p"===o?a="paragraph":"li"===o?a="list-item":"button"===o?a="button":"a"===o&&(a="link");const i=t.closest("section, article, div.section"),s=i&&i.querySelector("h1, h2, h3")?.textContent.trim()||"",l=Array.from(t.parentNode.children),r=l.indexOf(t);return{id:n,text:e,type:a,context:{preceding:r>0?l[r-1].textContent.trim():"",following:r<l.length-1?l[r+1].textContent.trim():"",sectionTitle:s},element:t}})).filter((t=>null!==t));return console.log("[Extract] Extracted",i.length,"content items."),i},_saveOriginalContent:function(){console.log("[Original] Saving original content...");const t=this.extractContent(),e={};t.forEach((t=>{e[t.id]={text:t.text,type:t.type,context:t.context}})),localStorage.setItem(this._originalContentKey,JSON.stringify(e)),console.log("[Original] Original content saved:",e)},_getOriginalContent:function(){console.log("[Original] Retrieving original content mapping.");const t=localStorage.getItem(this._originalContentKey);if(!t)return console.warn("[Original] No original content mapping found."),[];const e=JSON.parse(t),n=[];for(const t in e){const o=document.getElementById(t);o&&n.push({id:t,text:e[t].text,type:e[t].type,context:e[t].context,element:o})}return console.log("[Original] Retrieved",n.length,"original content items."),n},_restoreOriginalContent:function(){console.log("[Restore] Restoring original content...");const t=localStorage.getItem(this._originalContentKey);if(!t)return void console.warn("[Restore] No original content found.");const e=JSON.parse(t);for(const t in e){const n=document.getElementById(t);n&&(n.textContent=e[t].text,Array.from(n.classList).forEach((e=>{0===e.indexOf("translated-")&&(n.classList.remove(e),console.log(`[Restore] Removed class ${e} from element ${t}`))})),console.log(`[Restore] Restored element ${t}`))}console.log("[Restore] Finished restoring original content.")},translatePage:function(t){if(console.log(`[Translate] Translating page to: ${t}`),this.config.targetLanguage=t,localStorage.setItem("translation_language",t),console.log("[Translate] Saved target language in localStorage:",t),this._languageSelectorButton){const e=this._languageMapping[t]||t;this._languageSelectorButton.innerHTML=`<span>üåê</span> <span>${e}</span>`,console.log("[Translate] Updated language selector to:",e)}if(t===this.config.sourceLanguage)return console.log("[Translate] Target language is source. Restoring original content."),void this._restoreOriginalContent();const e=this._getOriginalContent();if(0===e.length&&this._translationRetries<3)return this._translationRetries++,console.warn("[Translate] No original items found; retrying in 500ms. Retry count:",this._translationRetries),void setTimeout((()=>{this.translatePage(t)}),500);this._translationRetries=0,this._sendTranslationRequest(e,(t=>{console.log("[Translate] Received translations:",t),this._applyTranslations(t)}))},_sendTranslationRequest:function(t,n){console.log("[API] Starting translation request for",t.length,"items.");const o=this._getCache(),a=[],i=[];if(t.forEach((t=>{const e=t.id+"-"+this.config.targetLanguage;o[e]?(console.log(`[API] Cache hit for ${t.id} using key ${e}`),i.push({id:t.id,translated:o[e]})):(console.log(`[API] Cache miss for ${t.id} using key ${e}.`),a.push(t))})),0===a.length)return console.log("[API] All translations found in cache."),void n(i);const s={sourceLanguage:this.config.sourceLanguage,targetLanguage:this.config.targetLanguage,siteId:this.config.siteId,content:a.map((t=>({id:t.id,text:t.text,type:t.type,context:t.context})))};console.log("[API] Sending payload to API:",s),e=!0,this._languageSelectorButton&&(this._languageSelectorButton.disabled=!0,this._languageSelectorButton.style.opacity=.6,this._languageSelectorButton.style.cursor="not-allowed",this._languageSelectorButton.innerHTML="<span>üåê</span> <span>Translating...</span>"),fetch(this.config.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(s)}).then((t=>{if(console.log("[API] Received response with status:",t.status),!t.ok)throw new Error("Translation API error: "+t.statusText);return t.json()})).then((t=>{if(console.log("[API] Data from API:",t),t.error)return void console.error("[API] API error:",t.error);t.translations.forEach((t=>{const e=a.find((e=>e.id===t.id));if(e){const n=e.id+"-"+this.config.targetLanguage;o[n]=t.translated,console.log(`[API] Caching translation for ${e.id} with key ${n}:`,t.translated)}})),this._setCache(o);const e=i.concat(t.translations);console.log("[API] Combined translations:",e),n(e)})).catch((t=>{console.error("[API] Translation request failed:",t)})).finally((()=>{if(e=!1,this._languageSelectorButton){const t=this._languageMapping[this.config.targetLanguage]||this.config.targetLanguage;this._languageSelectorButton.disabled=!1,this._languageSelectorButton.style.opacity=1,this._languageSelectorButton.style.cursor="pointer",this._languageSelectorButton.innerHTML=`<span>üåê</span> <span>${t}</span>`}}))},_applyTranslations:function(t){console.log("[Apply] Applying translations to elements."),t.forEach((t=>{const e=document.getElementById(t.id);e?(e.textContent=t.translated,Array.from(e.classList).forEach((n=>{0===n.indexOf("translated-")&&(e.classList.remove(n),console.log(`[Apply] Removed old class ${n} from element ${t.id}`))})),e.classList.add(`translated-${this.config.targetLanguage}`),console.log(`[Apply] Updated element ${t.id} with translation:`,t.translated)):console.warn("[Apply] No element found for key:",t.id)})),console.log("[Apply] Finished applying translations.")},_startTranslationPolling:function(){console.log("[Loop] Starting translation polling loop..."),setInterval((()=>{if(!this.config.targetLanguage||this.config.targetLanguage===this.config.sourceLanguage)return;if(e)return;const t=this.extractContent(),n=localStorage.getItem(this._originalContentKey),o=n?JSON.parse(n):{},a=this._getCache(),i=t.filter((t=>{const e=`translated-${this.config.targetLanguage}`,n=t.element.classList.contains(e),o=t.id+"-"+this.config.targetLanguage,i=a[o],s=n&&i&&t.element.textContent.trim()!==i;return s&&t.element.classList.remove(e),(!n||s)&&t.text.length>0}));i.length>0&&(console.log(`[Loop] Found ${i.length} new untranslated elements.`),i.forEach((t=>{o[t.id]={text:t.text,type:t.type,context:t.context}})),localStorage.setItem(this._originalContentKey,JSON.stringify(o)),this._sendTranslationRequest(i,(t=>{this._applyTranslations(t)})))}),1e3)},_addLanguageSelector:function(){console.log("[UI] Adding language selector UI.");const t=document.createElement("div");t.className="translation-language-selector no-translate",t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.background="white",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.boxShadow="0 2px 10px rgba(0,0,0,0.1)",t.style.zIndex="9999",t.style.overflow="hidden";const e=document.createElement("button"),o=this.config.targetLanguage||this.config.sourceLanguage,a=this._languageMapping[o]||o;e.innerHTML=`<span>üåê</span> <span>${a}</span>`,e.style.background="none",e.style.border="none",e.style.padding="10px 15px",e.style.cursor="pointer",e.style.display="flex",e.style.alignItems="center",e.style.gap="8px",e.style.fontFamily="system-ui, sans-serif",e.style.fontSize="14px",this._languageSelectorButton=e;const i=document.createElement("div");i.className="translation-language-dropdown",i.style.display="none",i.style.padding="5px 0",i.style.borderTop="1px solid #ddd";[{code:this.config.sourceLanguage,name:this._languageMapping[this.config.sourceLanguage]},{code:"hi",name:this._languageMapping.hi},{code:"mr",name:this._languageMapping.mr},{code:"ta",name:this._languageMapping.ta},{code:"kn",name:this._languageMapping.kn},{code:"pa",name:this._languageMapping.pa},{code:"gu",name:this._languageMapping.gu}].forEach((t=>{const e=document.createElement("button");e.textContent=t.name,e.dataset.language=t.code,e.style.background="none",e.style.border="none",e.style.padding="8px 15px",e.style.textAlign="left",e.style.cursor="pointer",e.style.width="100%",e.style.fontSize="14px",e.style.fontFamily="system-ui, sans-serif",e.addEventListener("click",(()=>{console.log(`[UI] Language option selected: ${t.code}`),n.translatePage(t.code),i.style.display="none",Array.from(i.children).forEach((t=>{t.style.backgroundColor="transparent"})),e.style.backgroundColor="#f0f0f0"})),i.appendChild(e)})),e.addEventListener("click",(t=>{t.stopPropagation(),i.style.display="none"===i.style.display?"block":"none",console.log("[UI] Toggled dropdown display to:",i.style.display)})),document.addEventListener("click",(e=>{t.contains(e.target)||(i.style.display="none",console.log("[UI] Click outside selector; hiding dropdown."))})),t.appendChild(e),t.appendChild(i),document.body.appendChild(t),console.log("[UI] Language selector UI added.")},init:function(t){if(console.log("[Init] Initializing TranslationSDK with options:",t),this.config={...this.config,...t},!this.config.siteId||!this.config.apiKey)return void console.error("[Init] TranslationSDK: siteId and apiKey are required");setTimeout((()=>{this._saveOriginalContent()}),50),this._addLanguageSelector(),this._setupRouteChangeListener(),this._startTranslationPolling();const e=localStorage.getItem("translation_language");console.log("[Init] Stored language:",e),setTimeout((()=>{this.config.autoTranslate?(console.log("[Init] Auto-translating to:",e||this.config.targetLanguage),this.translatePage(e||this.config.targetLanguage)):e&&(console.log("[Init] Translating to stored language:",e),this.translatePage(e))}),100),console.log("[Init] TranslationSDK initialization complete.")}};t.TranslationSDK=n,console.log("[Global] TranslationSDK attached to window.")}(window)}();
